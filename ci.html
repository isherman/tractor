

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Continuous Integration &mdash; farm_ng 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/tabs.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="References" href="references.html" />
    <link rel="prev" title="C++ API" href="cpp_api.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> farm_ng
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="libraries.html">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">FAQs, Tips &amp; Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="version_history.html">Version History</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_api.html">C++ API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Continuous Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building-farmng-devel">Building farmng/devel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#third-party-dependencies">third party dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">farm_ng</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Continuous Integration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ci.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="continuous-integration">
<h1>Continuous Integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline">¶</a></h1>
<p>For continuous integration we use github workflow actions to:</p>
<ul class="simple">
<li><p>run linters and static analyzers</p></li>
<li><p>publish docker development environment images</p></li>
<li><p>build and run tests on pull requests</p></li>
<li><p>publish release artifacts and docker images</p></li>
<li><p>run hardware-in-the-loop regression tests</p></li>
<li><p>run data-driven regression tests</p></li>
</ul>
<p>You can find our workflows under <a class="reference external" href="https://github.com/farm-ng/tractor/blob/master/.github/workflows">//.github/workflows</a>.</p>
<p>Our CI system is iteratively improving, and some of the above is still a work-in-progress.</p>
<p>For hardware-in-the-loop and data-driven regression tests we use a private repository and self-hosted runners.</p>
<section id="building-farmng-devel">
<h2>Building farmng/devel<a class="headerlink" href="#building-farmng-devel" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">farmng/devel</span></code> docker image contains all of the build dependencies for our repository.
It’s a big image and some of the build steps take time.
Luckily it changes slowly over time.</p>
<p>Pushing to the branch <code class="docutils literal notranslate"><span class="pre">devel</span></code> will cause CI to build <code class="docutils literal notranslate"><span class="pre">farmng/devel</span></code> using the github workflow located at
<a class="reference external" href="https://github.com/farm-ng/tractor/blob/devel/.github/workflows/devel.yml">//.github/workflows/devel.yml</a>.</p>
<section id="third-party-dependencies">
<h3>third party dependencies<a class="headerlink" href="#third-party-dependencies" title="Permalink to this headline">¶</a></h3>
<p>We prefer to depend on Ubuntu LTS packaged dependencies brought in via apt,
or the upstream pip, go, and npm package managers.
However some libraries are either too new to have packages (e.g. grpc), too esoteric (e.g. Sophus), or require
different build flags (e.g. opencv with gstreamer support).
These can be complex dependencies to build from source, and take a <em>long time</em> on devices like the Jetson Nano,
so we use docker multi-stage builds to manage these vendored dependencies.
We could have chosen to build debians, conda packages, or snaps, but since we’re already in docker land…</p>
<p>First, the <code class="docutils literal notranslate"><span class="pre">devel.yml</span></code> github action builds a docker image for each of the third party dependencies we build from source.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Devel docker images CI</span>

<span class="c1"># For all pushes to the devel branch push devel related images to registry tagged as `edge`</span>
<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
    <span class="nt">branches-ignore</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;master&quot;</span>
    <span class="nt">paths</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;docker/devel/**&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;.github/workflows/devel.yml&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;!docker/devel/Makefile&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;!docker/devel/docker-compose.yml&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;!docker/devel/user_devel.Dockerfile&#39;</span>


<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">third_party_build</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
    <span class="nt">strategy</span><span class="p">:</span>
      <span class="nt">matrix</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;libfmt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;cli11&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;apriltag&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;opencv&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;grpc&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;ceres&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;sophus&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>The resulting images only contain one layer, with headers and binaries
compiled and installed under the <a class="reference external" href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">prefix FHS</a>
<code class="docutils literal notranslate"><span class="pre">/farm_ng/env</span></code>.
The files in this layer are meant to be copied into other containers,
and the images themselves are small compared to the build-time requirements.</p>
<p>The images are pushed to the dockerhub repository <code class="docutils literal notranslate"><span class="pre">farmng/build-&lt;third</span> <span class="pre">party</span> <span class="pre">name&gt;</span></code>. For example, <code class="docutils literal notranslate"><span class="pre">farmng/build-grpc</span></code> is built from
<a class="reference external" href="https://github.com/farm-ng/tractor/blob/master/docker/devel/grpc.Dockerfile">//docker/devel/grpc.Dockerfile</a>.</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">ARG</span> <span class="nv">base_image</span><span class="o">=</span>ubuntu:18.04
<span class="k">FROM</span> <span class="s">$base_image</span>
<span class="k">RUN</span> apt-get update --fix-missing <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get install -y --no-install-recommends <span class="se">\</span>
    autoconf <span class="se">\</span>
    build-essential <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    git <span class="se">\</span>
    libtool <span class="se">\</span>
    pkg-config <span class="se">\</span>
    python3-pip <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="se">\</span>
    apt-get clean

<span class="k">RUN</span> pip3 install --upgrade pip <span class="o">&amp;&amp;</span> pip3 install cmake
<span class="k">RUN</span> git clone --depth<span class="o">=</span><span class="m">1</span> --recurse-submodules -b v1.34.0 https://github.com/grpc/grpc

<span class="k">ARG</span> <span class="nv">PREFIX</span><span class="o">=</span>/farm_ng/env
<span class="k">ARG</span> <span class="nv">PARALLEL</span><span class="o">=</span><span class="m">1</span>
<span class="k">RUN</span> <span class="nb">set</span> -ex <span class="o">&amp;&amp;</span> <span class="se">\</span>
    mkdir -p build-grpc <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build-grpc <span class="o">&amp;&amp;</span> <span class="se">\</span>
    cmake <span class="se">\</span>
    -DCMAKE_INSTALL_PREFIX<span class="o">=</span>/install_grpc <span class="se">\</span>
    -DCMAKE_PREFIX_PATH<span class="o">=</span><span class="nv">$PREFIX</span> <span class="se">\</span>
    -DCMAKE_BUILD_TYPE<span class="o">=</span>Release <span class="se">\</span>
    -DBUILD_SHARED_LIBS<span class="o">=</span>ON <span class="se">\</span>
    ../grpc <span class="o">&amp;&amp;</span> <span class="se">\</span>
    cmake --build . --parallel <span class="nv">$PARALLEL</span> --target install --config Release


<span class="k">FROM</span> <span class="s">scratch</span>
<span class="k">ARG</span> <span class="nv">PREFIX</span><span class="o">=</span>/farm_ng/env
<span class="k">COPY</span> --from<span class="o">=</span><span class="m">0</span> /install_grpc <span class="nv">$PREFIX</span>
</pre></div>
</div>
<p>Next, this workflow builds our devel image (<a class="reference external" href="https://github.com/farm-ng/tractor/blob/master/docker/devel/devel.Dockerfile">//docker/devel/devel.Dockerfile</a>),
which depends on the third party images described above:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">COPY</span> --from<span class="o">=</span>libfmt <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>cli11 <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>apriltag <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>ceres <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>grpc <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>opencv <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
<span class="k">COPY</span> --from<span class="o">=</span>sophus <span class="nv">$PREFIX</span> <span class="nv">$PREFIX</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We support x86 and the jetson platform, and would like to extend this to build for platforms in the near future using:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/docker/setup-buildx-action">https://github.com/docker/setup-buildx-action</a></p></li>
<li><p><a class="reference external" href="https://github.com/marketplace/actions/build-and-push-docker-images#multi-platform-image">https://github.com/marketplace/actions/build-and-push-docker-images#multi-platform-image</a></p></li>
</ul>
</div>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="references.html" class="btn btn-neutral float-right" title="References" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cpp_api.html" class="btn btn-neutral float-left" title="C++ API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, farm-ng inc.

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>